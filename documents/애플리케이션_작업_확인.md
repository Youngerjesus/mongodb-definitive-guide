# 애플리케이션 작업 확인 

이 장에서는 어플리케이션이 현재 실행 중인 일에 대해서 아는 방법과 이에 대해서 다루는 방법을 알아본다.

배울 내용은 다음과 같다. 

- 느린 작업을 찾아내서 강제로 종료하기 

- 컬렉션과 데이터베이스에 대한 통계를 가져오고 해석하기 

- 명령행 도구를 사용해서 현재 몽고 DB 가 실행 중인 작업을 찾아내기.

## 현재 실행 중인 작업 확인 

- 실행 중인 현재 작업을 확인할 수 있다. 

  - 운영중에는 크게 도움이 안될 수 있겠네.
  
  - `db.currentOp()` 를 통해서 확인하는게 가능하다. 대체로 느린 작업을 찾기 위해서 사용한다.

- `db.currentOp()` 에서 나오는 정보는 다음과 같다. 
  - `opId`: 작업의 고유 식별자.
  - `active`: 작업이 현재 실행중인지의 여부 
  - `secs_running`: 작업의 실행 기간을 초 단위로 보여줌. 
  - `microsecs_running`: 작업의 실행 기간을 마이크로초 단위로 보여줌.
  - `op`: 작업의 타입. (ex. query, insert, update, remove 타입이 있음.)
  - `desc`: 클라이언트 식별자.
  - `locks`: 작업으로 인해 획득한 락 타입을 설명. 
  - `waitingForLock`: 작업이 락을 획득하려고 기다리는 중인지 확인. 
  - `numYields`: 다른 작업의 실행을 위해 락을 포기하고 우위를 양보한 횟수. 일반적으로 도큐먼트를 검색하는 행위 (쿼리, 갱신, 제거) 는 양보할 수 있다.
  - `lockstats.timeAcquiringMicros`: 작업하는데 필요한 락을 획듣하는데 걸린 시간.

- `db.currentOp()` 은 필터링 조건을 넣어서 검색하는 것도 가능하다. 
  - `db.currentOp({"active": true, "secs_running": {"$gt": 3}}`

## 작업 강제 종료하기 

- `db.killOp()` 에 `opId` 를 넘겨줘서 갖제로 종료하는 것도 가능함.
  - 다른 작업을 위해서 양보할 수 있는 작업만 강제 종료가 가능하며 양보 했을 떄만 가능하다.
  - 즉 쿼리, 갱신, 제거만 가능하고 이것도 다른 작업을 위해서 양보했을 때만 가능함.
  
## 거짓 양성 

- 느린 작업 중에는 느려도 되는 작업들이 있다. 
  - 복제를 위한 oplog 를 가져오는 작업이나, 샤딩에 되한 write back listener 와 같은 작업들. 
  - write back listener 는 데이터 마이그레이션 중에 쓰기 작업을 relay 하면서 잘못된 곳으로 데이터 이동이 되지 않았는지 확인하는 프로세스다. 올바른 서버로 다시 보내는 역할을 함. 

## 유령 쓰기 방지 

- writeConcern 을 unacknowledged 로 설정하면 어플리케이션은 몽고 DB 가 처리하는 양보다 더 빠르게 데이터를 보낼 수 있다.
  - 이 경우 쓰기를 버거워해서 작업을 강제 종료해도 쓰기 작업이 진행될 수 있다. 
  - 이 경우가 발생하는 이유는 운영 체제 소켓 버퍼에 쓰인 쓰기 작업이 아직 남아있기 때문인데 이미 몽고로 들어온 소켓 버퍼에 대해서는 처리를 해야하므로 쓰기 작업이 일부 진행될 수 있다.

- 결국 이런 경우가 발생할 수 있기 떄문에 unacknowledged 쓰기 작업은 안하는게 낫다.
  - 과부하 이슈 떄문에.

## 시스템 프로파일러 사용 

- 시스템 프로파일러를 통해서 느린 작업을 알 수 있다. 
  - 이 정보는 `system.profile` 컬렉션에 기록된다. 
  - 프로파일러를 작동하면 몽고 DB 성능이 전반적으로 다운되기 떄문에 주기적으로 작동시켜서 트래픽의 일부를 얻어야한다. 
  - 이미 시스템에 부하가 심하다면 이 절에서 설명하는 다른 기법을 이용해보자. 
- 기본적으로 프로파일러는 꺼져 있으면 아무것도 안한다. 켜기 위해서는 `db.setProfilingLevel(2)` 을 통해서 설정할 수 있다.
  - 프로파일링 레벨 2면 모든 것을 프로파일링 한다는 의미다.
  - 즉 데이터베이스에서 받은 읽기와 쓰기 요청 모두는 `system.profile` 컬렉션에 기록된다.
  - 심각한 성능 저하를 일으킨다는 단점이 있다. 모든 쓰기는 추가 시간이 필요하고 모든 읽기는 write-lock 이 필요하다.
    - 몽고 DB 5.0 부터는 lock-free read operation 이 있다. 컬렉션에 exclusive write-lock 이 있다면.
      - 해당 read operation 종류는 다음과 같다. 
      - find, count, distinct, aggregate, mapReduce, listCollections, listIndexes
      - 컬렉션을 쓸 때 mapReduce, aggregate 연산은 exclusive lock (IX) 를 소유한다. 이떄 exclusive write-lock 이 소유되어있으면 작업하는데 블라킹 당한다.
  - 보통은 레벨을 1 로 설정해서 느린 작업만 프로파일링하도록 한다.
- 조회는 `db.system.profile.find()` 를 통해서 가능하다. 
  - `queryHash`, `planCacheKey` 항목은 느린 쿼리를 식별하기 위해서 들어온 쿼리 해쉬값과 플랜 캐시에 대한 해쉬값이다.

## 크기 계산 

- 몽고 DB 에 적절한 양의 디스크와 메모리를 제공해주려면 도큐먼트, 인덱스, 컬렉션, 데이터베이스가 공간을 얼마나 차지하는지 알아야한다. 
- 작업 셋 계산과 관련된 부분은 이후에 또 배운다. 

### 도큐먼트 사이즈 

- `object.bsonsize()` 를 통해서 몽고 DB 에 저장될 떄의 크기를 알 수 있다.

### 컬렉션 

- 전체 컬렉션에 대한 정보를 확인할 때는 `db.컬렉션이름.stats()` 를 통해서 확인이 가능하다.
  - `size` 필드는 모든 도큐먼트를 Object.bsonsize() 로 합친 값이다. 
  - 이는 메모리에서 압축하지 않았을 때의 사이즈임.
  - `storageSize` 는 압축된 사이즈이므로 `size` 보다 작다.
  - `nIndexes`: 는 컬렉션 내에있는 인덱스 수이다.
- 단위를 좀 더 깔끔하게 보고 싶다명 `1024`, `1024*1024` 이런식으로 넘겨줄 수 있다. 각각 킬로바이트, 메가바이트로 보는 방법이다.

### 데이터베이스

- `db.stats()` 를 통해서 데이터베이스 통계 정보를 보는것도 가능하다.
  - `fsTotalSize` 는 몽고 DB 데이터베이스가 저장하는 총 저장량이므로 파일 디스크는 이것보다 커야한다.
  - `fsUsedSize` 는 몽고 DB 가 사용하고 있는 총 공간이다.
  - `dataSize` 는 압축되지 않은 데이터 사이즈를 말한다.
  - `indexSize` 는 이 데이터베이스가 사용하는 모든 인덱스가 차지하는 공간이다.

## mongotop 과 mongostat 사용 

- `mongotop --locks` 를 실행하면 각 데이터베이스 락에 대한 통계 정보를 알 수 있고 이를 바탕으로 가장 분주한 컬렉션을 알 수 있다. (top 과 유사. 몇 초마다 상태를 계속해서 출력함.)

- `mongostat` 은 서버 차원의 정보를 제공한다.
  - 복제셋이나 샤드 클러스터에서 실행 가능
  - `insert/query/update/delete/getmors/command`: 각 연산의 발생 횟수 
  - `flushes`: 몽고 DB 가 플러쉬 한 횟수 
  - `mapped`: mongod 가 매핑한 메모리의 양 일반적으로 데이터 디렉터리의 크기 
  - `vsize`: mongod 가 사용중인 가상 메모리의 양 
  - `res`: mongod 가 사용중인 메모리의 양 
  - `locked d`: 마지막 타임 슬라이스에 락이 가장 많이 걸린 데이터베이스 
  - `idx miss %`: 페이지 폴트를 해야했던 인덱스 접근 비율 
  - `qr:qw`: 읽기 및 쓰기용 큐의 크기 즉 중단된 채 처리되기를 기다리는 읽기와 쓰기의 수 
  - `ar:aw`: 읽기 및 쓰기를 수행하는 현재 활동 중인 클라이언트의 수 
  - `netIn`: 몽고 DB 에 집계된 바이트 단위의 네트워크 유입량 
  - `netOut`: 몽고 DB 에 집계된 네트워크 유출량 
  - `conn`: 서버가 열어놓은 커넥션 수 
  - `time`: 통계가 찍힌 시

## Review 

- lock 에 대해서 정리해야곘다 
- 모니터링 시스템에서 쓰는 지표가 mongostat 인가 
