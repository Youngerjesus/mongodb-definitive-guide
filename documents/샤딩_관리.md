# 샤딩 관리 

여기서는 replicaset 과 마찬가지로 샤드 클러스러틀 관리하는 여러 옵션을 배운다. 

다루는 내용은 다음과 같다. 

- 멤버가 누구고, 데이터가 어디에 보관되었고, 어떤 연결이 열려있는지 등의 클러스터 상태 검사 

- 클러스터 멤버 추가, 제거, 변경 

- 데이터 이동 관리 및 수동 관리 

## 현재 상태 확인 

- `sh.status()` 는 샤드, 데이터베이스, 샤딩된 컬렉션의 개요를 제공해준다.

### 구성 정보 확인하기 

- 클러스터 정보는 모두 config 서버의 config 데이터베이스 내 컬렉션에 보관된다. 
- config 데이터베이스에 접근하려면 `mongos` 에 접근한 후 `use config` 를 통해서 데이터베이스를 선택하면 된다. 
- 일반적으로 config 정보는 수정하면 안되고 수정해도 재시작해야 반영된다. 

- config 내에 있는 데이터베이스 정보는 다음과 같다.
  - config.shards
    - 클러스터 내 모든 샤드를 추적하는 역할을 한다. 
    - `db.shard.find()` 를 통해서 볼 수 있다.
  - config.databases
    - 클러스터가 알고 있는 모든 샤딩 및 비샤딩 데이터베이스를 추적한다.
    - `enableSharding` 이 적용되어 있으면 `partitioned` 라는 칼럼이 true 로 설정되어있다.
      - `enbaleSharding` 은 데이터베이스를 만드는 역할을 한다. 거기서 컬렉션을 추가하면 샤딩되고 
  - config.collections 
    - 모든 샤딩된 컬렉션을 추적한다.
    - `db.collections.find().pretty()` 를 통해서 볼 수 있다. 
    - 주요 칼럼을 보면 다음과 같다.
      - `_id`: 컬렉션 네임 스페이스 
      - `key`: 샤드키 
      - `unique`: 샤드키가 고유 인덱스가 아님을 나타냄. (기본적으로 고유 인덱스 아님.)
  - config.chunks
    - chunks 컬렉션은 모든 컬렉션 내 청크 기록을 보관한다. 
    - 주요 칼럼을 보면 다음과 같다.
      - `_id`: 청크 식별자. 일반적으로 컬렉션 네임 스페이스 + 샤드 키 + 하위 청크 범위로 구성됨. 
      - `ns`: 청크가 위치한 컬렉션 
      - `min`: 청크 범위 내 최솟값
      - `max`: 청크 범위 내 최대값 
      - `shard`: 청크가 위치하는 샤드 
      - `lastmod`: 청크 버전 관리로 이전 청크가 새 청크로 쪼개지는 경우 구별하기 위해서 있다. 
        - 첫 번쨰 값은 새 샤드로 마이그레이션 횟수, 두 번쨰 값은 청크 분할 횟수이다.
  - config.changelog
    - 발생한 분할과 마이그레이션을 모두 기록한다. 
  - config.settings
    - 밸런서 설정과 청크 크기를 나타내는 도큐먼트를 포함한다. 
    - 구성 서버에 연결해서 데이터를 변경하지 말고 항상 mongos 에 연결해야한다. 
    
## 네트워크 연결 추적 

- `db.adminCommand({"connPollStats": 1})` 와 같은 `connPoolStats` 명령을 통해서 샤드 클러스터나 복제 셋 멤버로 나가는 연결 정보를 얻을 수 있따. 


## 서버 관리

- 샤드를 추가하거나 제거할 수 있는데 이를 많이 하면 청크가 옮겨다니므로 부하르 준다. 
  - `db.adminCommand({"removeShard": "shardName"})` 을 통해 샤드를 제거하는게 가능하다
    - 이 경우에 밸런서가 켜진걸 확인해야 밸런서가 해당 샤드에 있는 청크를 다른 샤드에 옮긴다. 
    - 이를 `draining` 이라고 한다.
  - 서버 추가는 `mongos` 에 연결한 후 `addShard` 하면 된다.

## 데이터 밸런싱 

- `sh.setBalancerState(false)` 를 통해 밸런서를 끌 수 있다.
  - 밸런서를 끄는 이유는 데이터 자동 분배를 끌려고 하는 거겠지. 
  - `db.locks.find({"_id": balancer})["state]` 를 통해 밸런서가 켜져있는지 꺼져있는지 확인할 수 있다. 0 이 꺼져있는 것.
- 일반적으로 밸런싱 작업은 시스템에 부하르 준다. 
  - 목적지 샤드로 원본 샤드에 있는 모든 도큐먼트를 쿼리하고 샤드에 입력해야한다. 그릭 원본 샤드는 제거해야한다. 
  - 일반적으로 샤딩 구성을 핫스팟 전략으로 하는 경우에 밸런싱이 많이 일어날 수 있다. 
  - `config.settings` 컬렉션에서 밸런싱 시간대를 예약하는 것도 가능하다.

## 점보 청크 

- 샤드 키로 `date` 필드로 정했다고 해보자. 그리고 이 필드는 `년/월/일` 만 포함된다.
  - 이 청크는 매일 하나씩만 생겨날 것.
  - 근데 청크가 엄청 커지면? 청크 사이즈를 뛰어넘어도 샤드 키가 동일하기 떄문에 나눌 수 없다. 즉 움직이지도 쪼개지도 못하는 이런 청크를 점보 청크라고한다.
  - (밸런서는 점보 청크를 옮기지지 못한다.)
  - `sh.status()` 에서 점보 청크를 조회하는 것도 가능하다. 
- 점보 청크를 해결할려면 밸런서를 끄고 청크 사이즈를 올리고 청크를 옮기고 다시 청크 사이즈를 맞추고 밸런서를 키면 된다.
  - `db.settings.save({"_id": "chunksize", "value": "지정값"})` 을 통해서 청크 사이즈를 변경하는게 가능하다.
- 애초에 점보 청크가 생기지 않도록 샤드 키를 잘 지정해야한다

## Review 

- 구성 서버 정보를 알 수 있다는 점. 
- 점보 청크의 문제에 대해서, 이에 대해 대응하는 점 들을 알았다. 
