# 모니터링 

여기서 다룰 모니터링 내용은 다음과 같다. 

- 몽고 DB 메모리 사용을 추적하는 방법 

- 애플리케이션 성능 지표를 추적하는 방법 

- 복제상의 문제를 진단하는 방법 

## 몽고 DB 메모리 사용을 추적하는 방법 

- 페이지 fault 가 났다는 건 디스크에 그만큼 접근해서 데이터를 읽어와서 메모리에 적재하고 있는 과정이므로 성능이 안나올 것.

  - 디스크에서 메모리에 적재하는 속도를 빠르게 하기 위해서 SSD 를 사용하거나 모든 접근하는 데이터를 메모리에 올릴 수 있도록 하는 것 
  - 디스크가 과부하가 걸리면 PageFault 는 문제가 될 수 있다. 그만큼 대기해야 하니까.
  - `db.adminCommand({"serverStatus": 1})["extra_info"]` 명령을 통해서 `page_fault` 가 얼마나 일어났는지 확인할 수 있다.
  - **PageFault 가 일어났다는 증거로 CPU 사용 시간을 보면 된다. I/O Wait 인 경우 CPU 는 idle time 으로 체크하고 CPU 를 사용한 시간으로 체크한다.** 


## 작업 셋 계산

- 메모리에 데이터가 모두 있다면 연산이 굉장히 빠를 것.

## 성능 계산 

- **CPU 사용량이 높다는 건 인덱스를 사용하지 않는 쿼리가 있을 수 있다.**
  - 정상적인 경우에는 cpu 가 15% 가 max 로 찍힌다. 100% 가 찍힌다는 건 문제가 있음.
  - 또는 queueing 지표를 보면 된다. 큐잉 지표는 몽고 DB 가 쿼리를 실행하기 위해서 락을 얻을려고 대기하는 시간을 말한다.
- 와이어드 타이거 스토로지 엔진은 도큐먼트 수준의 동시성을 지원한다. 
  - 즉 여러 도큐먼트를 동시에 수정하는게 가능하다. 
  - `serverStatus` 의 `wiredTiger.concurrentTransactions.read.available` 과 `wiredTiger.concurrentTransactions.write.available` 을 참고하면 된다. 
  - 여기에 있는 스레드를 다 쓴다면 큐에 누적된다. 
  - 일반적으로 큐에 요청이 쌓인다는게 부하를 따라갈 수 없다는 뜻.

## 디스크 사용량 계산

- 디스크 사용량을 모니터링 해야지 현재 드라이브가 얼마나 오랫동안 유지될 수 있는지 예측할 수 있다.
  - `df` 명령을 통해 디스크 사이즈, 현재 사용량, 남은 사용량을 알 수 있다.

- **공간이 부족하면 다음 옵션을 사용하는 것도 가능하다.** 
  - 샤드를 추가한다.
  - 사용하지 않는 인덱스가 있다면 제거하자. `$indexStats` 를 사용해 식별할 수 있다. 
  - 복제셋의 멤버를 하나씩 종료시키고 큰 디스크를 가진 장비로 마이그레이션 시킨다.
  - 복제 셋의 멤버를 종료시키고 큰 디스크를 가진 멤버를 넣어서 새로운 멤버가 따라 잡도록 한다. 그리고 이를 반복한다.

## 복제 모니터링

- 복제 지연 (replication lag) 는 0에 가까울수록 좋다.
- 세컨더리가 복제 지연을 못한다면 `_id` 인덱스의 누락 때문에 일어날 수 있다.
- 시스템이 과부하라면 복제 지연은 점점 생길 수 있다. 
- oplog 길이도 하루를 넘기는게 기본이고 몇 주 정도 되야한다.
