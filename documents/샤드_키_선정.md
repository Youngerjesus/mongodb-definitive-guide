# 샤드 키 선정 

샤딩을 이용할 때 가장 중요한 건 데이터를 어떻게 분산화 하는지를 결정하는 것. (샤드 키 선정)

여기서는 다음과 같은 내용을 다룬다. 

- 가능한 샤드 키 중에서 결정하는 방법 

- 샤드 키 사용 사례 

- 샤드 키로 사용할 수 없는 것

- 사요자 정의 형태로 데이터를 분산할 때 전략

- 데이터를 수동으로 샤딩하는 방법 

## 용도 평가 

- 샤드 키는 데이터를 분산화 할 수 있는 키 (= 컬렉션의 필드) 를 말한다. 

- 좋은 샤드 키를 정하기 위해서는 어플리케이션의 요청이 어떻게 분산화 되는지, 작업량은 어떻게 되는지를 이해해야한다. 


## 샤딩 구상 

- 데이터를 분할할 때는 `오름차순`, `무작위`, `위치 기반 키` 를 가장 일반적으로 사용한다. 

### 오름차순 샤드 키 

- 오름차순 샤드 키의 예는 `ObjectId` 나 `date` 와 같은 필드이다. 
  - `ObjectId` 를 구성하는 데이터 중에는 타임 스탬프 값이 들어간다. 
- 예전에 샤드 키를 배웠을 떄 `minKey`, `maxKey` 가 있고 이 사이에 파티션이 생겨서 샤딩이 되었었다. 
- 오름차순 샤드키를 쓰면 새롭게 생겨나는 데이터는 `maxKey` 를 가진 쪽의 샤드에만 들어가게 된다. 
  - 이로 인해서 하나의 샤드에서 계속해서 청크가 발생해 나눠진다. 
  - 결과적으로 데이터 불균형이 생길 수 있고, 청크가 계속해서 옮겨다니는 문제가 생긴다.

### 무작위 분산 샤드 키 

- 예는 UUID, 사용자 이메일 등이 있다. 
- 무작위 샤드 키를 쓰면 데이터가 잘 분산된다.
- 다만 단점은 몽고 DB 메모리 크기를 넘어서는 데이터를 접근하는 데는 효율적이지 않다고 한다. (뭔 소린지 모르겠다. )

### 위치 기반 샤드 키 

- 사용자 IP, 경도와 위도, 주소 등이 있다.
- 특정 데이터를 특정 샤드에 넣도록 할 수 있다. 
  - 주로 데이터를 사용자와 가까운 곳에 두는 식으로 하는 방법이다. 

### 샤드 키 전략 

- 해시 샤드 키 
  - 데이터를 샤딩 해서 적재하므로 무작위 분산이 된다. 다만 범위 쿼리가 되지 않는다는 단점이 있다. 
  - 장점은 오름차순 키를 쓴다 하더라도 해시값을 통해서 적재하므로 무작위로 분산할 수 있다.
  - 쓰기는 밸런스 있게 읽기는 하나만 읽어와도 된다면 해시 샤드 키를 쓰면 좋다. 
  - 해시 샤드 키를 쓸려면 해시 인덱스를 생성해야한다. 
    - `db.users.createIndex({"username": "hashed"})`

### 파이어호스 전략 

- 파이어 호스 전략은 특정 강력한 샤드가 있다면 그 쪽으로 요청을 몰아넣는 전략이다. 
  - 샤드를 Zone 에 등록하고 Zone 에 샤드 키들을 매핑하는 식으로 하면 해당 샤드에 많은 데이터를 몰아 넣을 수 있다. 
  - `sh.addShardToZone("shard0000", "Zone001)` 로 등록하고 
  - `sh.updateZoneKeyRange("dbName.collName", {ShardKey Range 1}, {ShardKey Range 2}, "ZoneName")` 으로 존과 샤드 키를 매핑한다. 

### 다중 핫스팟 전략 

- 이건 골고루 분산하면서 오름차순 (= 정렬된 형태) 로 데이터를 저장하는 기법이다. 
  - 정렬해서 넣으면 데이터를 넣는 비용 자체는 좋다. (독립 실행형 기준으로.)
- 이걸 가능하게 하려면 복합 키 (1. 카디널리티가 조금 낮은 키, 2. 정렬할 수 있는 키 ex ObjectId) 로 하면 된다. 
  - 그러면 1 번 기준으로 철크가 나눠지는데 2번 으로 정렬되서 들어간다. 
- 이 방법은 특정 청크들에 데이터가 몰리게 시작하면 청크 분리되면서 결국 무작위 쓰기랑 같아 진다

## 샤드 키 규칙 및 지침 

- 샤드 키는 배열이 될 수 없다. 
- 고르게 분산화 될 수 있는 키를 선택해야한다. 그리고 카디널리티가 높은 값이면 좋다.
  - 키 값이 같으면 분산할 수 없다. 같은 키는 같은 샤드에 있어야 하므로. 

## 데이터 분산 제어 

- 자동 데이터 분산은 사용자의 요구 사항과 맞지 않는 경우가 있다.
  - 여기서는 자동 분산을 넘어서는 몇 가지 방법을 다룬다. 
- 실시간 컬렉션은 가장 파워가 쎈 샤드에게만 보내고 싶은 경우 
  - 샤드에 존을 등록하고 존에 컬렉션과 샤드 키를 등록하면 해당 샤드에서만 데이터를 저장하도록 하고 처리할 수 있다. 

### 수동 샤딩 

- 데이터가 분산되는 걸 완전히 제어하고 싶은 경우가 있을 수 있다. 
  - 이 경우에는 밸런서를 꺼야한다.
  - `sh.stopBalancer()` 를 통해 밸런서를 비활성화 해야한다. 
  - `db.chunks.find()` 를 통해 청크의 위치를 찾아ㄴ낼 수 있다. 
  - `db.moveChunk()` 를 통해 청크를 이동시킬 수 있다.
