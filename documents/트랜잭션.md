# 트랜잭션

몽고 DB 는 여러 작업, 컬렉션, 도큐먼트 및 샤드에서 ACID 호환 트랜잭션을 지원한다. 

여기서는 트랜잭션을 소개하고, ACID 를 정의하고, 애플리케이션에서 이를 이용하는 방법을 강조하며 몽고 DB 에서 트랜잭션을 조정하는 팁을 배운다. 

- 트랜잭션은 무엇인가

- 트랜잭션을 사용하는 방법 

- 어플리케이션을 위한 트랜잭션 제한 조정 (tuning)

## 트랜잭션 사용법 

몽고 DB 는 트랜잭션을 사용하기 위한 두 가지 API 를 제공한다. 

- 코어 API 라는 관계형 DB 와 유사한 구문 (예를 들면 start_transaction, commit_transaction 과 같은 것.)

  - 오류에 대한 재시도 로직을 포함하지 않으며, 개발자가 이를 직접 구현해야한다. 
  
- 권장되는 방식인 콜백 API
  
  - 지정된 논리 세션과 관련된 트랜잭션 시작, 콜백 함수로 제공된 함수 실행, 트랜잭션 커밋 등 코어 API 보다 많은 기능을 지원해준다. 물론 재시도 로직도 포함해서. 
  - 이런 기능들은 몽고 DB 4.2 이후부터 들어온다. 

**코어 API 든 콜백 API 든 트랜잭션을 사용할 때 논리 세션을 시작해야 한다.** 

- 트랜잭션은 논리 세션과 연결이 되어야 한다. 
- 논리 세션은 몽고 DB 배포 컨택스트에서 작업의 시간과 순서를 추적한다. 
- 논리 세션은 재시도 기능과 순서에 따른 인과관계를 지원해주는 인과적 일관성 (causal consistency) 를 지원해준다. (그냥 순서대로 처리해준다. 이 뜻인듯.)

**이 장에서는 코어 API 와 콜백 API 예제를 보니 코어 API 가 훨씬 복잡하다. 그냥 콜백 API 를 사용해라 이 뜻인거 같다.**

## 어플리케이션을 위한 트랜잭션 제한 조정

**어플리케이션이 트랜잭션을 최적으로 이용하기 위해서 트랜잭션을 사용할 때 몇가지 알아야 할 매개변수가 있다.**

### 타이밍과 oplog 크기 제한

몽고 DB 트랜잭션에는 두 가지 주요 제한 범주가 있다. 

- 트랜잭션의 시간과 관련된 제한. (트랜잭션이 실행될 시간, 락을 획득하는데 걸리는 시간, 트랜잭션이 실행될 최대 길이를 제어하는 것.)

- 몽고 DB oplog 항목과 개별 항목에 대한 크기 제한.

  - oplog 는 데이터 변경에 대한 operation 들을 기록해놓는 로그다. 풀네임은 `operation log` 임. 

먼저 시간 제한을 보자. 

- 트랜잭션의 최대 실행 시간은 1분이다.

  - 이 값은 `mongod` 인스턴스 레벵에서 `transactionLifetimeLimitSeconds` 에 의해서 제어되는 제한을 수정해 증가시킬 수 있다. 
  - 샤드 클러스터를 쓴다면 모드 샤드 복제 및 멤버에 매개변수를 설정해야한다. 
  - 이 시간이 경과되면 트랜잭션이 만료되었다고 간주하며 주기적으로 실행되는 정리 프로세스에 의해서 정리된다. 
  - 정리 프로세스는 60초와 `transactionLifetimeLimitSeconds / 2` 중 더 나은 값을 주기로 실행된다. 

- 트랜잭션에 시간 제한을 명시적으로 걸려면 `commitTransaciton` 에 `maxTimeMS` 를 지정하는 것이 좋다. `maxTimeMs` 를 지정하지 않으면 `transactionLifetimeLimitSeconds` 가 사용된다.
  - `maxTimeMs` 를 설정했지만 `transactionLifetimeLimitSeconds` 를 초과한다면 `transactionLifetimeLimitSeconds` 이 갑이 사용된다.

- 트랜잭션 작업에 필요한 락을 획득하기 위해 트랜잭션이 대기하는 최대 시간은 기본적으노 `5ms` 이다.
  - 이 값은 `maxTransactionLockRequestTimeoutMillis` 에 의해 제어되는 제한을 늘릴 수 있다. 
  - 이 시간 내에 락을 획득하지 못하면 트랜잭션은 중단된다. 
  - 이 값을 0 으로 설정한다면 락을 즉시 얻지 못하면 트랜잭션은 중단된다. 
  - 이 값을 -1 로 설정한다면 `maxTimeMS` 에 지정된 값을 사용한다.
  - 이 값을 0 보다 큰 값으로 설정하면 해당 시간까지 락을 얻을려고 대기한다.

Oplog 크기 제한을 보자. 

- 몽고 DB 는 트랜잭션의 쓰기 작업에 필요한 만큼 `oplog` 항목을 생성한다. 각 oplog 항목은 BSON 도큐먼트 크기 제한인 16MB 이하여야한다. 

유연성있는 모델과 스키마 설계 패턴을 사용했다면 대부분의 상황에서는 트랜잭션을 사용하지 않아도 된다. 어플리케이션에서 트랜잭션을 드물게 사용하는 것이 좋다.


