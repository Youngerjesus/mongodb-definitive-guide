# 복제 셋 설정

여기서는 몽고 DB 고가용성 (high-available) 시스템인 복제 셋을 다룬다.

단순히 테스트/개발 운영 환경을 위한 복제 셋을 만들고 싶다면 몽고 DB 클라우드 솔루션인 몽고 DB 아틀라스를 사용해보자.

## 복제 셋 설정 

Primary-Secondary 를 실제로 설정하는 부분인데 이 작업을 하는 경우가 있을 때 다시 보면 될 듯.

## 복제 관찰

`db.isMaster()` 명령을 내리면 `rs.status()` 명령보다 훨씬 간결하게 복제 셋 상태를 볼 수 있다.

- 누가 Primary 인지 Secondary 인지 확인하는게 가능하다.
- `rs.status()` 도 replica set 의 상태와 동작을 확인할 수 있다.

몽고 DB 의 Secondary 는 Primary 의 데이터보다 신선하지 않다. (stale) 좀 기다려야 동기화됨.

- 그리고 읽을 때도 기본적으로 거부된다. 프라이머리가 아니라는 이유로. 

- Secondary 에서 읽어도 괜찮다라고 설정하려면 `secondaryDB.setSlaveOK()` 하면 된다. 

  - `setSlaveOK()` 는 데이터베이스가 아니라 데이터베이스 연결에 해당되는 옵션이다.

Primary 가 종료되었을 때 페일오버가 자동으로 된다. 

- 이 명령을 내리면 `db.adminCommang({"shutdown": 1})` 해당 인스턴스를 종료하는게 가능하다. 

- 프라이머리의 중단을 가장 먼저 발견한 세컨더리가 프라이머리로 승격된다.

## 복제 셋 구성 변경

복제 셋 구성은 언제든지 변경, 추가, 삭제할 수 있다.

- `rs.add("localhost:27017")` 과 같은 명령을 통해서 복제 멤버를 추가하는게 가능하다.
- `rs.remove("localhost:27017")` 와 같은 명령을 통해서 복제 멤버를 제거하는 것도 가능하다.
- 재구성 여부는 `rs.config()` 명령을 통해서 확인하는게 가능하다.
- 수정을 할려면 `rs.reconfig(config)` 명령을 통해 가능하다.

## 복제 셋 설계 방법

복제 셋을 설계하기 위해서는 과반수 (majority) 개념을 알아야한다.

프라이머리는 과반수 이상이어야만 프라이머리 자격을 유지하는게 가능하다. 쓰기도 과반수 이상이어야 안전하다.

- 예로 복제셋이 5 멤버로 이뤄지면 과반수는 3이다. 이 경우에 3 개의 노드가 다운되면 두 개의 노드로는 프라이머리를 선출할 수 없다.

- 과반수 룰을 만든 이유는 프라이머리 선출 때문인데 노드가 다운되었지만 몽고 DB 입장에서는 다운되었는지, 네트워크 에러인지 알 지 못한다.

  - 이 경우에 과반수 룰이 없다면 3개의 노드에서 프라이머리가 선출되고, 두 개의 노드에서 또 프라이머리가 선출됨으로써 두 개의 프라이머리가 생길 수 있다는 문제가 있다.
  - 이 경우를 막기 위해서 프라이머리 선출에는 과반수 룰이 적용된다.
  
- 복제 셋 구성을 다음과 같이 할 수 있다.
  - 데이터센터로 구별을 하는 경우에 하나의 데이터 센터에서만 프라미머리가 선출될 수 있도록 과반수를 넣어두는 경우. (그리고 거기에 프라이머리가 있다.)
  - 양쪽 데이터센터에 동일한 개수를 두고 또 다른 데이터센터에 과반수를 넣을 수 있는 하나의 노드를 넣는 경우 (대아터센터 구별이 딱히 필요가 없다면.)

## 프라이머리 선출은 어떻게 되는가?

세컨더리가 프라이머리가 될 때 다른 멤버들에게 자신을 알리고 프라이머리가 되도록 요청한다.

요청을 받은 멤버는 프라이머리가 될 수 있는지 검사한다.

- 우선순위를 바탕으로.
- 최신의 복제 데이터를 가지고 있는지 바탕으로.

합의 알고리즘은 RAFT 합의 프로토콜을 따른다.

우선 순위가 높은 멤버가 프라이머리가 되도록 노력하며 그렇게 될 가능성이 제일 높지만 잠시 동안은 우선순위가 낮은 멤버가 프라이머리가 될 수도 있다.

## 멤버 구성 옵션

복제 셋 멤버들은 기본적으로 모두 동일하지만 동일하지 않도록 설정할 수도 있다.

- 특정 멤버가 우선적으로 프라이머리가 되거니
- 클라이언트에게 보이지 않도록 요청이 라우팅 되지 않도록 하거나

### 우선순위

우선순위는 특정 멤버가 프라이머리가 될 수 있는 지표다.

- 0 부터 100 사이를 넣을 수 있으며 높을수록 프라이머리가 될 수 있다. 
- 기본값은 1이다.
- 0 으로 지정하면 절대 프라이머리가 될 수 없다.

**우선순위 값이 높은 멤버가 최신 데이터로 동기화가 되면 프라이머리로 된다.**

- 최신 데이터로 동기화 되기 전에는 다른 노드가 잠시 프라이머리가 될 수 있다. 
- 최신 데이터로 동기화되지 못하면 프라이머리가 될 수 없다.

### 숨겨진 멤버

멤버 설정에 `hidden: true` 를 넣으면 멤버에 요청이 라우팅 되지 않는다. 

주로 백업 서버를 사용할 때 쓴다. 

이 경우에 `db.isMaster()` 를 통해 볼 때 검출되지 않는다.

### 아비터 선출

복제셋 멤버를 2로 설정하는 경우가 있다. (바람직하지 않지만 소규모로 운영해야 할 경우.)

이 경우에는 한 노드가 다운되면 과반수가 없어서 프라이머리가 되지 못하는데 이를 해결하기 위해서 아비터라는 특수 멤버를 사용한다.

아비터는 데이터를 가지지 않는다. 클라이언트에서도 사용할 수 없다. 과반수를 구성하기 위해서만 사용된다.

- `rs.addArb("server-5:27017)` 과 같은 명령을 통해서 아비터를 추가하는게 가능하다.

- 아니면 `rs.add({"_id": 4, host: "server-5:27017", "arbiterOnly": true})` 와 같은 명령을 통해서도 가능하다.

일반적으로 아비터를 쓰느건 권장되지 않는다. 그냥 데이터노드를 하나 더 쓰자.

## 인덱스 구축

때떄로 세컨더리는 프라이머리 처럼 인덱스를 가지지 않아도 된다. 

- 백업 용도, 오프라인 배치 작업 용도 라면.

- 세컨더리에 `buildIndexes: faluse` 설정을 하면 인덱스를 생성하지 않는다. 

  - 이 설정은 영구적인 설정이다. 조심하자. 
  - 이렇게 설정한 애는 숨겨진 멤버로 등록해야 하고 멤버의 우선순위가 0이어야 한다.
