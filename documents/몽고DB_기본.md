# 몽고DB 기본

- 몽고 DB 의 데이터 단위는 도큐먼트 (document) 이고 이는 관계형 데이터베이스 기준으로 행과 같다.
- 몽고 DB 의 컬렉션 (collection) 은 동적 스키마 (dynamic schema) 가 되는 테이블과 같다.
  - 하나의 컬렉션 내 도큐먼트들은 다른 구조를 가지는게 가능하다.
- 모든 도큐먼트는 컬렉션 내에서 고유한 값인 `_id` 를 가진다.
- 몽고 DB 는 몽고 셀 (The mongo shell) 과 함께 배포되는데 mongo 셀을 통해 몽고 DB 인스턴스를 관리하고 몽고 DB 쿼리 언어로 데이터를 조작할 수 있다. 그리고 사용자의 스크립트를 로드할 수 있도 있다. 자바스크립트 해석기 (javascript interpreter 라고 보면 된다.)
- `mongod` 는 MongoDB 의 주 데몬 프로세스다. 데이터 요청과 데이터 접근을 다루고 백그라운드 연산을 다룬다. (MongoDB 시작할 때 사용)

## 서브 컬렉션

- 서브 컬렉션 (sub collection) 은 `.` 를 통해서 컬렉션을 구별한다. 
- 예를 들어서 블로그 기능이 있는 어플리케이션이 있다면 `db.blog.posts` 를 통해 게시물 컬렉션에 접근할 수 있다.
- 이런 방식은 단지 쳬게화를 위함이라서 `db.blog` 컬렉션이 없어도 된다. 관련이 없다.

## 데이터베이스

- 데이터베이스는 컬렉션을 그룹핑하기 위함이다.
- 몽고 DB 단일 인스턴스는 여러개의 데이터베이스를 호스팅하는게 가능하다. 
- 의미있는 데이터베이스도 있다.
  - admin: admin 데이터베이스는 인증과 권한 부여 역할을 한다.  
  - local: 단일 서버에 대한 데이터를 저장한다. replica set 에서 local 데이터베이스 자체는 복제되지 않는다. replication process 에서 사용된 데이터를 저장한다.
    - `mongod` 가 가지고 있는 데이터베이스이기도 하다. 
    - replication 과 관련된 설정 정보들을 가지고 있는듯.
  - config: 샤딩할 때 사용하며 몽고 DB 클러스터는 config 데이터베이스를 이용해서 각 샤드의 정보를 저장한다.

## 몽고 DB 시작

- mongod 실행 파일을 시작해야함. 
  - 인수 없이 시작하면 기본 데이터 디렉터리로 `/data/db` 를 이용한다.
  - 기본적으로 `27017` 번 포트에서 소켓 연결을 기다린다.

## 몽고 DB 셀

- 셀을 통해서 몽고 DB 인스턴스와 상호작용하는게 가능하다. 
- `mongo` 를 통해서 셀을 시작할 수 있다.
  - 셀은 자바스크립트 해석기라서 자바스크립트 프로그램을 실행하는게 가능하다. 
  - 자바스크립트 프로그래밍도 가능함.
- `db` 라는 전역변수를 통해서 데이터베이스 연결을 제공해준다.
- 셀에서 CRUD 가 가능하다.
  - `db.movies.insertOne(movie)` 이런식으로 데이털넣는게 가능함. 넣는건 `insertOne, insertMany`.
  - 찾는건 `find, findOne()` 을 통해서 가능하다. find 는 일단 20개까지 자동으로 출력한다.
  - `updateOne` 을 통해서 업데이트 가능. 매개변수는 두 개를 받고 첫 번째는 수정할 도큐먼트를 찾는 것, 두 번째는 갱신 작업을 설명할 도큐먼트다.
```javascript
db.movies.updateOne(
    { title: "Star wars"},
    { $set: { reviews: []}}
)
```
  - 삭제는 `deleteOne, deleteMany` 를 통해서 가능하다. 매개변수로 찾을 조건을 선택하면 되고 `deleteMany` 는 조건에 해당하는 모든 문서를 지운다.


## 데이터형

몽고 DB 는 JSON 형과 닮았다. 근데 JSON 형에는 지원하지 않는 여러가지 형식을 추가로 제공한다.

- null 형을 지원한다. 
  - `{ "x": null}`
- Boolean 형을 지원하다.
  - `{ "x": true }`
- 날짜형도 지원한다. time zone 은 지정하지 않는다.
- 정규 표현식도 지원한다.
  - `{ "x": /footbar/i}`
- 배열도 지원한다. 
  - 서로 다른 데이터 형을 값으로 포함하는 것도 가능하다.
  - 중첩 배열도 가능하다.
  - 배열에 쿼리하거나, 배열의 요소들을 가지고 인덱스 하는게 가능하다.
- 내장 다큐먼트도 지원한다. 
  - `{ "x": { "foo": "bar" }}`
  - 내장 다큐먼트도 배열처럼 인덱스 하는게 가능하다.
- 객체 ID 도 지원한다. (12바이트 ID 이다.)
  - `{ "x": ObjectId() }`
  - `_id` 가 ObjectId() 이다. 
  - 이 값은 고유하면서 랜덤적으로 생긴다. 자동적으로 1씩 증가하는 관계형 데이터베이스와는 다른데 이를 통해 동기화 시간이 적게 걸리고 분산 설계에 맞다.
  - 12 바이트 이므로 24 자리 16진수가 가능하다.
  - 첫 4 바이트는 타임 스탬프 값이다.
    - 이를 통해 대략 입력 순서대로 정렬이 된다.
    - 초 단위의 유일성을 제공해준다.
  - 다음 5 바이트는 랜덤 값이다.
  - 마지막 3 바이트는 서로 다른 시스템에서 값이 충돌하지 않도록 랜덤 값으로 시작하는 카운터다.
  - 즉 ObjectId 의 앞 9바이트는 1초 동안 여러 장비와 프로세스에 걸쳐 유일성을 부여하고 마지막 3바이트를 통해서 1초 내 단일 프로세스의 유일성을 보장한다.
  - ObjectId 는 1초에 256^3 (1677만 7216개) 까지 생성된다.
  - `_id` 값을 명시하지 않고 도큐먼트를 입력하면 자동으로 추가된다.
- 이진 데이터도 지원하지만 셀에서는 조작이 불가능하다. 
- 코드도 넣을 수 있다. 

## 셀 사용 

인스턴스 연결 

```text
$ mongo some-host:30000/myDB
```

- some-host:30000 의 myDB 데이터베이스에 연결한다.

mongod 연결 하지 않을 때

```text
$ mongo --nodb 
```

