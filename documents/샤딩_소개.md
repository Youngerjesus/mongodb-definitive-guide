# 샤딩 소개 

## 샤딩이란 

- **데이터의 서브셋을 분산해서 여러 장비에 넣는 걸 말한다.**
- 일반적으로 스케일 업이 아니라 스케일 아웃을 말한다.
- 샤딩은 다른 용도로도 사용하는데 더 자주 접근하는 데이터를 가진 장비만을 업그레이드 하는 식으로도 사용한다.
- 일반적인 수동 샤딩 (manual sharding) 은 어떤 데이터베이스를 쓰더라도 가능한데 노드를 추가하거나, 삭제하거나, 부하 패턴을 바꾸는 경우등에 대해서 약하다.
- 몽고 DB 는 자동 샤딩을 지원해준다. 
  - 이를 통해 어플리케이션은 독립 실행형 몽고 DB 와 통신하는 것처럼 이용한다.
  - 자동 샤딩을 하면 데이터가 이리저리 옮겨 다니기도 한다. 그래서 관리해야 할 요소도 많다. 
  - 관리를 할꺼라면 몽고 DB 아틀라스나 옵스 매니저를 이용하면 된다.
  - 컴퓨팅 인프라 제어를 해야한다면 옵스 매니저를, 인프라 관리를 몽고 DB 에 맡길려면 몽고 DB 아틀라스를 사용하면 된다.
- **샤딩의 목적은 여러 데이터베이스의 클러스터 들이 하나처럼 보이도록 하는 것이다.**
- 이러한 세부 사항을 숨기기 위해서 몽고 샤드 클러스터 앞단에 `mongos` 라는 애를 둔다. 
  - `mongos` 는 라우팅 프로세스다. 애플리케이션은 라우터에 연결해서 사용한다. (샤드 클러스터가 아니라면 어플리케이션은 `mongod` 와 직접 연결해서 사용한다.)
    - `mongod` 는 몽고 DB 에서 실행되는 백그라운드 프로세스이다.
  - `mongos` 는 어떤 샤드가 어떤 데이터를 포함하고 있는지 알려주는 컨텐츠 목차를 가지고 있다.

## 단일 장비에서의 샤딩 

- 단일 장비에서 샤딩 클러스터를 구성하고 테스트하는 방법이 있다. 
- 이는 `ShardingTest` 라는 몽고 DB 내부 클래스를 통해서 만들 수 있다. 
- 샤딩 결과는 `sh.status()` 를 통해서 볼 수 있다.
- 특정 컬렉션을 먼저 샤딩할려면 `sh.enableSharding("accounts")` 를 통해서 할 수 있다.
- 컬렉션을 샤딩할 떈 데이터를 분산화 시킬 샤드 키를 선정해야한다. 
  - 샤드키를 선택하는 건 데이터 정렬의 순서를 생각하는 것과 같다. 예로 `username` 을 샤드키로 지정했다면 몽고 DB 는 이름을 기반으로 데이터를 나눈다.
    - `a1-stack-sauce` ~ `defcon`, `defcon1` ~ `howic1998` 이런식으로.
  - 컬렉션이 커질수록 샤드키가 엄청 중요해진다.
  - 샤드키 범위에 따라서 데이터 청크가 생긴다.
- 쿼리를 날릴 때 단일 샤드나 샤드 서브셋으로 보내는 쿼리를 타겟 쿼리 (target query) 라고 하고 모든 샤드로 보내야하는 쿼리를 분산-수집 쿼리 (scatter-gather query) 라고 한다.

### ShardingTest 

```javascript
st = ShardingTest(
        {
          name: "one-min-shards", 
          chunkSize: 1, 
          shards: 2,
          rs: {
              nodes: 3,
              oplogSize: 10  
          },
          other: {
              enableBalancer: true 
          }
        }
)
```

- 샤딩에도 replication 을 걸 수 있다.

### 샤드키 생성 

샤딩하기 전에 샤딩을 할려는 키에 대해서 인덱스를 생성해야한다. 

```javascript
db.users.createIndex({"username": 1}) // 인덱스 생성
```

이제 샤딩이 가능해진다.

```javascript
sh.shardCollection("accounts.users", {"username": 1})
```
